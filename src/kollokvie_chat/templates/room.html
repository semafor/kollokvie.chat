% rebase('base.html', title='View room')

<div class="header">
    <h1>{{room.name}}</h1>
</div>

<div class="sidebar">
    % if len(rooms) > 0:
    <h2>Your channels:</h2>
    <ul class="channellist">
        % for r in rooms:
        <li><a href="{{r.get_url()}}">{{r.name}}</a></li>
        % end
    </ul>
    % end
</div>

<div id="chat-box" class="main">

    <ul class="messages" id="message_list">
      % for message in messages:
        <li data-msg-id="{{message.get_id()}}">
            % if message.get_owner().avatar:
                <img class="user-avatar" src="{{message.get_owner().avatar}}">
            % else:
                <img class="user-avatar" src="/default.jpeg">
            % end
            <p class="user-name">
                <span class="user-label">{{message.get_owner().name}}</span>
                <span class="message-date">{{message.human_readable_date()}}</span>
            </p>
            <span class="messagecontent">{{message.content}}</span>
        </li>
      % end
    </ul>

</div>

<div class="footer">
    <div class ="editor">
        <form id="message_form" action="/room/{{room.get_id()}}/{{room.slug}}/say" method="POST">
            <input class="messageinput" id="message_input" type="text" placeholder="Say somethingâ€¦" name="message">
            <button class="messagebutton" for="message_form">Enter</button>
        </form>
    </div>
</div>


<script type="text/javascript" src="/room_client.js"></script>
<script type="text/javascript">

var message_list = document.getElementById("message_list");

var form = document.getElementById("message_form");
var message_input = document.getElementById("message_input");
var timeoutId;
var body = document.getElementsByTagName('body')[0];

form.addEventListener('submit', function (e) {
    e.preventDefault();

    var data = new FormData(form);

    // No message entered, ignoring.
    if (!message_input.value) {
        return;
    }

    var cid = makeid();
    data.append('client_id', cid);
    var xhr = new XMLHttpRequest();
    xhr.open('POST', form.action, true);

    // TODO: more event callbacks
    xhr.onload = function () {
        message_input.value = "";
    };
    xhr.send(data);
});

timeoutId = window.setInterval(function () {
    poller("{{room.get_url()}}/messages/from/" + get_last_msg_id());
}, 250);

window.onload = function () {
    scrollToBottom();
}

window.onerror = function(messageOrEvent) {
    if (messageOrEvent == "Error: no messages") {
        body.classList.add('bad-poll-response');
        return true;
    }

    return false;
};

</script>

